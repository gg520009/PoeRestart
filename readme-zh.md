# PoeRestart - PoE 电源控制器

[English Version](README.md)

本项目基于 STM32 微控制器实现了一个 PoE (Power over Ethernet) 电源管理控制器。设计用于配合 **LTC4294** PD (Powered Device) 接口控制器，管理大功率协商（高达 71W）并安全控制下游电源分配。

## 功能特性

- **功率协商监控**: 持续监控 LTC4294 的 T2P 和 PWGD 信号，以确定可用功率预算。
- **软启动与时序控制**: 管理 DC-DC 转换器和输出继电器的使能信号，防止浪涌电流并确保启动稳定。
- **状态指示**:通过 LED 闪烁模式指示系统运行状态（等待、协商、电源正常或故障）。
- **保护机制**: 包含独立看门狗 (IWDG) 和故障检测逻辑，在协商失败或不稳定时断开电源。
- **DMA 优化**: 使用 DMA 进行 ADC 采样和 UART 日志记录，以最大限度地减少 CPU 占用。

## 硬件配置

系统基于运行在 64MHz (HSI/PLL) 的 STM32 微控制器（如 STM32F0/G0 系列）。

### 引脚映射

| 引脚 | 功能 | 类型 | 描述 |
| --- | --- | --- | --- |
| PA0 | **T2P** | ADC | 采样 LTC4294 T2P 信号（功率可用性） |
| PA1 | **PWGD** | ADC | 采样 LTC4294 Power Good 信号 (>1.5V = 正常) |
| PA2 | **Powerkeyin**| In | 输入控制信号 (配置为高/低电平有效) |
| PA4 | **LB16F1** | Out | LED 控制指示灯 (跟随 Powerkeyinstate 状态) |
| PA5 | **AP** | Out | AP 时序输出控制 |
| PA6 | **DC-DC EN** | Out | DC-DC 使能控制 (**低电平** = 使能) |
| PA7 | **RELAY** | Out | 输出继电器控制 (**高电平** = 闭合/开启) |
| PB0 | **LED** | Out | 状态 LED (开漏输出, 低电平 = 亮) |
| PB3 | **USART1_TX** | UART | 调试日志输出 (115200 bps) |

## 软件逻辑

系统在 10µs 时基上运行状态机。

### 状态 1: 等待 Power Good（电源正常）

- **指示**: 快闪 (1 Hz / 0.5s 亮, 0.5s 灭)
- **行为**: 监控 `PA1` (PWGD)。
  - 如果 PWGD > 1.5V，尝试使能 DC-DC 和继电器。
  - 如果 PWGD 大约 3 秒保持稳定，系统进入 **状态 2**。
  - 如果 PWGD 不稳定，保持输出禁用。

### 状态 2: 功率协商检查

- **指示**: 中速闪烁 (0.5 Hz / 1s 亮, 1s 灭)
- **行为**: 分析 `PA0` 上的 T2P 信号以确定分配的功率。
  - 采集 8192 个样本（约 82ms 窗口）。
  - 检查 T2P 平均电压是否对应 **71W** 等级 (约 2.3V - 2.6V)。
  - **成功**: 如果 71W 有效，进入 **状态 3**。
  - **失败**: 如果功率协商失败（例如 < 71W），进入 **状态 4**。

### 状态 3: 正常运行 (高功率)

- **指示**: 慢闪 (~0.16 Hz / 3s 亮, 3s 灭)
- **行为**:
  - **电源输出**: **已使能** (PA6 低, PA7 高)。
  - 只要电源稳定，系统将保持在此状态。

### 状态 4: 故障 / 低功耗模式

- **指示**: LED 灭
- **行为**:
  - **电源输出**: **已禁用** (PA6 高, PA7 低)。
  - 系统在此状态停留 3 秒，然后重置为 **状态 1**。

### 附加控制逻辑 (并行)

系统与主状态机并行运行附加控制任务：

#### 1. Powerkeyin 控制 (PA2)

- **输入监控**: 使用 **500ms 软件消抖** 滤波器持续监控 `PA2`。
- **状态更新**: 更新全局变量 `Powerkeyinstate` (1 = 激活/高, 0 = 非激活/低)。

#### 2. LB16F1 指示灯 (PA4)

- 直接反映 `Powerkeyinstate`。
- **亮**: `Powerkeyinstate` == 1.
- **灭**: `Powerkeyinstate` == 0.

#### 3. AP 时序控制 (PA5)

在 `Powerkeyinstate` 变迁时触发非阻塞时序：

- **0 -> 1 变迁**: `关 (10ms)` -> `开 (300ms)` -> `关 (10ms)` -> `空闲 (关)`.
- **1 -> 0 变迁**: `关 (10ms)` -> `开 (8000ms)` -> `关 (10ms)` -> `空闲 (关)`.

## 编译说明

本项目使用 STM32CubeMX 生成，可以使用 **STM32CubeIDE** 进行编译。

1. 在 STM32CubeIDE 中打开项目目录。
2. 确保项目设置中选择了正确的 MCU 目标。
3. 编译项目 (Ctrl+B)。
4. 将二进制文件烧录到目标板。

## 许可证

本项目根据 LICENSE 文件中提供的条款进行许可。如果未提供许可证，则按原样提供 (AS-IS)。
Copyright (c) 2026 STMicroelectronics.
